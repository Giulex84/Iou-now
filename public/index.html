<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ’ IOU Now â€” Test Payment</title>

  <!-- Pi SDK v2 (load by script tag) -->
  <script src="https://sdk.minepi.com/v2/sdk.js" defer></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f6f8fb; color:#222; text-align:center; padding:28px; }
    h1 { color:#5a2ecf; margin-bottom:6px; }
    .status { margin-bottom:12px; }
    button { margin:8px; padding:12px 20px; border-radius:8px; border:none; cursor:pointer; background:#5a2ecf; color:#fff; font-size:1rem; }
    button:disabled { background:#a7a7a7; cursor:not-allowed; }
    #result { margin-top:18px; padding:12px; background:#fff; border-radius:8px; display:inline-block; min-width:260px; word-break:break-word; box-shadow:0 1px 3px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  <h1>ğŸ’ IOU Now â€” Test Payment</h1>
  <div class="status">SDK Status: <span id="sdk_status">â³ Loading...</span></div>

  <button id="startBtn" disabled>ğŸ’° Authenticate & Pay (Test)</button>
  <button id="clearBtn">ğŸ”„ Clear Debug</button>

  <div id="result">ğŸ“œ Ready for test.</div>

  <script>
    const sdkStatus = document.getElementById('sdk_status');
    const startBtn = document.getElementById('startBtn');
    const resultBox = document.getElementById('result');
    const clearBtn = document.getElementById('clearBtn');

    // 1) EVENT: SDK ready (this is the most reliable hook)
    window.addEventListener('pi-sdk-ready', () => {
      try {
        Pi.init({ version: "2.0" });
        sdkStatus.textContent = 'âœ… SDK ready';
        startBtn.disabled = false;
      } catch (err) {
        sdkStatus.textContent = 'âŒ Init error';
        console.error('Pi.init error', err);
      }
    });

    // 2) Timeout fallback (if SDK not present within 5s)
    setTimeout(() => {
      if (typeof Pi === 'undefined') {
        sdkStatus.textContent = 'âš ï¸ SDK not loaded â€” open in Pi Browser or re-validate domain';
        startBtn.disabled = true;
      }
    }, 5000);

    // Clear debug
    clearBtn.onclick = () => {
      resultBox.textContent = 'ğŸ“œ Debug cleared.';
      console.clear();
    };

    // Main flow: authenticate and request payment
    startBtn.onclick = async () => {
      resultBox.textContent = 'â³ Authenticating...';
      try {
        const scopes = ['username','payments'];
        const auth = await Pi.authenticate(scopes, (p) => console.log('incomplete payment', p));
        resultBox.textContent = `âœ… Authenticated as @${auth.user.username}. Creating payment...`;

        const payment = {
          amount: 0.001,
          recipient: 'GDT-test', // test recipient
          memo: 'IOU Now test payment',
          metadata: { app: 'IOU Now' }
        };

        await Pi.requestPayment(payment, {
          onReadyForServerApproval: (paymentId) => {
            resultBox.textContent = 'ğŸ”„ User approved â€” contacting server...';
            fetch('/api/approve', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ paymentId })
            })
            .then(r => r.json())
            .then(data => {
              if (data && data.txid) {
                // small delay to stabilize SDK
                setTimeout(() => { Pi.complete(data.txid); resultBox.textContent = `ğŸ”” Server approved â€” TXID: ${data.txid}`; }, 800);
              } else {
                Pi.cancel(paymentId);
                resultBox.textContent = 'âŒ Server error or invalid response.';
              }
            })
            .catch(err => {
              Pi.cancel(paymentId);
              resultBox.textContent = 'âŒ Network error while approving.';
              console.error(err);
            });
          },
          onPaymentCompleted: (txid) => {
            resultBox.textContent = `ğŸ‰ Payment completed! TXID: ${txid}`;
          },
          onCancel: () => {
            resultBox.textContent = 'âŒ Payment canceled by user.';
          },
          onError: (error) => {
            resultBox.textContent = `âŒ SDK Error: ${error && error.message ? error.message : 'Unknown'}`;
            console.error('Pi SDK error', error);
          }
        });

      } catch (err) {
        resultBox.textContent = `âŒ General error: ${err && err.message ? err.message : err}`;
        console.error(err);
      }
    };
  </script>
</body>
</html>
